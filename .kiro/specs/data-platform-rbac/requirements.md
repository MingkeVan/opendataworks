# 数据中台权限管理系统需求文档

## 简介

数据中台权限管理系统旨在为现有的数据平台提供细粒度的访问控制能力。系统将基于用户角色和权限，控制用户对Doris数据库、工作流等资源的访问权限，确保数据安全和合规性。系统将集成现有的OAuth认证体系，实现统一的用户身份管理和权限控制。

## 术语表

- **权限管理系统**: 负责管理平台用户与规范化Doris用户映射关系的核心系统
- **规范化Doris用户**: 每个数据库标准配置的读写用户和只读用户
- **数据库读写用户**: 对特定数据库具有完整读写权限的Doris用户
- **数据库只读用户**: 对特定数据库仅具有查询权限的Doris用户
- **用户权限映射**: 平台用户ID与数据库访问权限级别的对应关系
- **工作流资源**: DataTask数据处理和调度相关的工作流程
- **OAuth集成**: 与现有OAuth认证系统的集成接口
- **DorisConnectionService**: 现有的Doris数据库连接服务组件

## 需求

### 需求 1

**用户故事:** 作为系统管理员，我希望能够管理用户角色和权限，以便控制不同用户对数据资源的访问范围。

#### 验收标准

1. WHEN 管理员创建新用户角色 THEN 权限管理系统 SHALL 允许定义该角色的权限范围并持久化存储
2. WHEN 管理员为用户分配角色 THEN 权限管理系统 SHALL 更新用户权限映射并立即生效
3. WHEN 管理员修改角色权限 THEN 权限管理系统 SHALL 更新所有拥有该角色用户的权限并记录变更日志
4. WHEN 管理员删除用户角色 THEN 权限管理系统 SHALL 检查角色使用情况并安全移除未使用的角色
5. WHEN 管理员查看权限配置 THEN 权限管理系统 SHALL 显示完整的用户-角色-权限映射关系

### 需求 2

**用户故事:** 作为普通用户，我希望只能访问被授权的数据库和工作流，以便在权限范围内安全地使用系统功能。

#### 验收标准

1. WHEN 用户登录系统 THEN 权限管理系统 SHALL 基于OAuth用户信息获取用户权限并建立会话
2. WHEN 用户访问数据库列表 THEN 权限管理系统 SHALL 仅返回用户有权限访问的数据库
3. WHEN 用户查询数据库内容 THEN 权限管理系统 SHALL 验证用户对该数据库的访问权限
4. WHEN 用户访问工作流列表 THEN 权限管理系统 SHALL 仅显示用户有权限查看的工作流
5. WHEN 用户尝试执行未授权操作 THEN 权限管理系统 SHALL 拒绝访问并返回权限不足错误

### 需求 3

**用户故事:** 作为系统架构师，我希望权限系统能够与现有OAuth体系无缝集成，以便复用现有的用户认证基础设施。

#### 验收标准

1. WHEN OAuth系统提供用户信息 THEN 权限管理系统 SHALL 解析用户ID和用户名并映射到内部用户模型
2. WHEN 用户首次登录 THEN 权限管理系统 SHALL 自动创建用户记录并分配默认权限
3. WHEN OAuth令牌过期 THEN 权限管理系统 SHALL 清理相关会话并要求重新认证
4. WHEN 系统需要验证用户身份 THEN 权限管理系统 SHALL 通过OAuth接口验证令牌有效性
5. WHEN 用户信息发生变更 THEN 权限管理系统 SHALL 同步更新用户基本信息

### 需求 4

**用户故事:** 作为数据库管理员，我希望能够基于规范化的Doris用户体系管理平台用户权限，以便实现标准化的数据访问控制。

#### 验收标准

1. WHEN 管理员配置数据库权限规范 THEN 权限管理系统 SHALL 为每个数据库维护标准的读写用户和只读用户
2. WHEN 管理员为平台用户分配数据库权限 THEN 权限管理系统 SHALL 将用户映射到相应数据库的读写用户或只读用户
3. WHEN 用户通过DorisConnectionService访问数据 THEN 权限管理系统 SHALL 根据用户权限选择对应的Doris用户凭据建立连接
4. WHEN 用户查询数据库列表 THEN 权限管理系统 SHALL 仅返回用户有权限访问的数据库
5. WHEN 用户执行数据操作 THEN 权限管理系统 SHALL 通过对应的Doris用户权限自动控制操作范围

### 需求 5

**用户故事:** 作为工作流管理员，我希望能够控制用户对DataTask工作流的访问和操作权限，以便确保工作流的安全执行。

#### 验收标准

1. WHEN 管理员设置工作流权限 THEN 权限管理系统 SHALL 支持查看、创建、编辑、执行、删除等不同级别权限
2. WHEN 用户访问工作流列表 THEN 权限管理系统 SHALL 根据用户权限和owner字段过滤可见的工作流
3. WHEN 用户尝试编辑工作流 THEN 权限管理系统 SHALL 验证用户是否为owner或具有编辑权限
4. WHEN 用户执行工作流 THEN 权限管理系统 SHALL 检查用户的执行权限和相关DolphinScheduler数据源权限
5. WHEN 工作流涉及多个Doris数据源 THEN 权限管理系统 SHALL 验证用户对所有相关数据源的访问权限

### 需求 6

**用户故事:** 作为系统集成者，我希望权限系统能够与现有的DolphinScheduler数据源管理无缝集成，以便统一管理数据访问权限。

#### 验收标准

1. WHEN 用户创建使用Doris数据源的任务 THEN 权限管理系统 SHALL 验证用户对该数据源的访问权限
2. WHEN 系统查询DolphinDatasourceOption列表 THEN 权限管理系统 SHALL 仅返回用户有权限访问的数据源
3. WHEN 用户选择数据源创建任务 THEN 权限管理系统 SHALL 确保用户对目标数据库具有相应操作权限
4. WHEN 任务执行时访问数据源 THEN 权限管理系统 SHALL 使用统一的权限验证机制
5. WHEN 数据源权限发生变更 THEN 权限管理系统 SHALL 同步更新相关任务的可执行状态