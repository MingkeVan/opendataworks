# 数据中台权限管理系统实施计划

## 实施概述

将现有的数据平台改造为支持用户权限管理的系统，通过规范化Doris用户方案实现细粒度的数据访问控制。每个任务都基于现有架构进行增量开发，确保系统的稳定性和可维护性。

## 任务列表

- [x] 1. 建立用户权限基础架构
  - 创建用户权限相关的数据表结构
  - 实现OAuth用户信息映射到平台用户
  - 建立基础的权限服务接口
  - _需求: 1.1, 1.2, 3.1, 3.2_

- [x] 1.1 创建权限管理数据表
  - 创建platform_users表用于存储平台用户信息
  - 创建doris_database_users表用于配置每个数据库的标准用户
  - 创建user_database_permissions表用于用户权限映射
  - 编写数据库迁移脚本
  - _需求: 1.1, 1.2_

- [x] 2. 实现权限服务核心功能
  - 实现UserMappingService获取用户对应的Doris凭据
  - 创建权限管理的管理员接口
  - 保持逻辑简单，依赖Doris原生权限
  - _需求: 1.3, 1.4, 1.5, 4.2_

- [x] 2.1 实现用户映射服务
  - 开发UserMappingService根据用户ID和数据库获取Doris凭据
  - 实现根据用户权限级别选择readonly/readwrite用户的逻辑
  - 创建Doris数据库用户配置管理功能
  - _需求: 4.2, 4.3_

- [x] 2.2 创建权限管理接口
  - 开发管理员权限分配接口（用户-数据库权限映射）
  - 实现权限撤销功能
  - 创建权限查询接口
  - _需求: 1.3, 1.4, 1.5_

- [ ]* 2.3 编写权限服务核心功能的属性测试
  - **属性2: 权限映射正确性** - 验证用户权限正确映射到Doris用户凭据
  - **验证: 需求 4.2, 4.3**

- [x] 3. 实现统一的用户上下文管理
  - 创建用户上下文管理机制（ThreadLocal + AOP）
  - 实现切面统一处理用户身份获取和传递
  - 修改DorisConnectionService使用用户上下文获取对应凭据
  - _需求: 4.3, 4.5_

- [x] 3.1 创建用户上下文管理组件
  - 创建UserContext类管理当前用户信息
  - 实现UserContextHolder使用ThreadLocal存储用户上下文
  - 创建用户上下文的设置和清理机制
  - _需求: 3.1, 3.2_

- [x] 3.2 实现用户身份切面
  - 创建@RequireAuth注解标记需要用户身份的方法
  - 实现AuthenticationAspect切面自动获取和设置用户上下文
  - 确保用户上下文在请求结束后自动清理
  - _需求: 3.1, 3.2_

- [x] 3.3 修改DorisConnectionService使用用户上下文
  - 修改DorisConnectionService从UserContextHolder获取当前用户
  - 集成UserMappingService获取用户对应的Doris凭据
  - 无需修改方法签名，保持现有接口不变
  - _需求: 4.3, 4.4, 4.5_

- [ ]* 3.4 编写用户上下文管理的属性测试
  - **属性3: 用户上下文正确性** - 验证用户上下文在切面中正确设置和清理
  - **属性4: 用户凭据正确性** - 验证用户获取到正确的Doris用户凭据
  - **验证: 需求 3.1, 3.2, 4.3**

- [x] 4. 应用用户身份切面到控制器
  - 在相关Controller方法上添加@RequireAuth注解
  - 依赖切面自动处理用户身份，无需修改Controller逻辑
  - 确保所有需要权限的接口都应用了用户身份管理
  - _需求: 2.2, 2.4, 5.2_

- [x] 4.1 更新DorisClusterController应用切面
  - 在listDatabases和listTables方法上添加@RequireAuth注解
  - 依赖切面自动设置用户上下文
  - 无需修改Controller方法内部逻辑
  - _需求: 2.2_

- [x] 4.2 更新DataTableController应用切面
  - 在表统计信息、DDL查看、数据预览方法上添加@RequireAuth注解
  - 依赖切面和DorisConnectionService自动使用用户凭据
  - 保持Controller方法签名不变
  - _需求: 2.3, 4.5_

- [x] 4.3 更新DataQueryController应用切面
  - 在SQL查询执行方法上添加@RequireAuth注解
  - 查询历史方法添加用户过滤逻辑
  - 依赖切面自动处理用户身份
  - _需求: 2.3, 2.5_

- [x] 4.4 更新工作流相关Controller应用切面
  - 在工作流相关方法上添加@RequireAuth注解
  - 工作流列表添加基于owner的过滤逻辑
  - 依赖切面自动处理用户上下文
  - _需求: 5.2, 5.3, 5.4, 6.1_

- [ ]* 4.5 编写切面应用的属性测试
  - **属性5: 切面应用正确性** - 验证@RequireAuth注解正确触发用户身份处理
  - **验证: 需求 3.1, 3.2**

- [ ] 5. 实现权限管理前端界面
  - 创建简单的权限管理界面
  - 实现用户-数据库权限分配功能
  - 依赖后端Doris权限自然过滤，前端无需额外处理
  - _需求: 1.5_

- [ ] 5.1 创建权限管理页面
  - 开发用户列表和数据库权限分配页面
  - 实现权限分配（readonly/readwrite）和撤销界面
  - 创建Doris数据库用户配置管理界面
  - _需求: 1.5_

- [ ] 5.2 处理权限相关的用户体验
  - 实现权限不足时的友好错误提示
  - 确保前端正确处理权限相关的API错误
  - 无需修改现有页面，依赖后端自然过滤
  - _需求: 2.2, 2.4, 5.2_

- [ ]* 5.3 编写前端权限管理的集成测试
  - 测试权限管理界面的完整功能
  - 测试权限分配和撤销功能
  - 测试权限不足时的错误处理





- [ ]* 6.3 编写系统集成的属性测试
  - **属性6: 端到端权限正确性** - 验证从用户登录到数据访问的完整权限流程
  - **验证: 需求 3.1, 4.3, 4.5**

- [x] 7. 最终检查点 - 确保所有测试通过
  - 确保所有测试通过，如有问题请询问用户

## 实施注意事项

### 架构设计原则
1. **高内聚低耦合** - 使用AOP切面统一处理用户身份，避免在每个Controller重复代码
2. **最小侵入性** - 通过注解和切面，无需修改现有方法签名和业务逻辑
3. **依赖Doris原生权限** - 应用层只负责用户身份映射，数据过滤交给Doris处理

### 开发优先级
1. **用户上下文管理优先** - 先实现切面和ThreadLocal的用户上下文管理
2. **权限映射服务优先** - 实现用户到Doris凭据的映射逻辑
3. **接口应用切面** - 在现有接口上应用@RequireAuth注解

### 测试策略
- **属性测试** - 使用jqwik进行属性基础测试，每个测试至少100次迭代
- **切面测试** - 重点测试AOP切面的正确性和ThreadLocal的线程安全
- **集成测试** - 使用TestContainers测试完整的权限控制流程

### 风险控制
- **渐进式部署** - 每个任务完成后进行充分测试
- **线程安全** - 确保ThreadLocal在并发环境下的正确性
- **内存泄漏防护** - 确保用户上下文在请求结束后正确清理