# DolphinScheduler 发布快照分阶段实施计划

## 0. 概述

- 目标：基于《DolphinScheduler 发布快照与版本治理设计》落地数据库快照、版本对比及回滚能力。
- 范围：后端（数据模型、服务链路）、运维脚本、前端展示、回滚治理流程。
- 方法：分阶段交付，每阶段可独立上线并向下一阶段提供依赖能力。

## 阶段规划总览

| 阶段 | 目标 | 核心交付 | 预计周期 |
| --- | --- | --- | --- |
| Phase 0 | 设计确认 & 基线梳理 | 方案评审、任务排期、基线数据清单 | 0.5 周 |
| Phase 1 | 快照数据模型 | 新表上线、DAO & 实体、迁移脚本 | 1 周 |
| Phase 2 | 发布写快照 | 发布流程改造、快照落库、失败补偿 | 1.5 周 |
| Phase 3 | 版本查询 & Diff | 查询接口、diff 生成、前端版本列表 | 1 周 |
| Phase 4 | 回滚能力 | 回滚 API、前端触发、审计记录 | 1 周 |
| Phase 5 | 运营与治理 | 监控、巡检、操作手册、培训 | 0.5 周 |

## Phase 0：设计确认 & 基线梳理

- **目标**：确认需求范围、资源分配，梳理现状数据作为上线基线。
- **关键任务**
  - 评审设计文档，确认快照字段、哈希算法、diff 粒度。
  - 列出当前已发布的 Dolphin 任务、血缘数据量、潜在历史缺失。
  - 制定数据补录/迁移策略（baseline 快照方案、回滚限制说明）。
  - 拆解实施任务，明确负责人与排期。
- **验收标准**
  - 评审会议纪要与确认稿。
  - 基线任务清单 & 数据风险说明。
  - 项目计划排期获得技术负责人和产品确认。

## Phase 1：快照数据模型落地

- **目标**：新增 `workflow_definition_snapshot` 表及相关访问层，确保可在不影响现有功能的情况下写入记录。
- **关键任务**
  - 打表脚本（含索引、字段注释、默认值），生成 Flyway/ Liquibase 迁移。
  - 编写 Entity、Mapper、DAO 单测，确保 CRUD 正常。
  - 约定 `workflow_key` 生成规则与 `content_hash` 算法（例如 `sha256(definitions + relations)`）。
  - 提供临时写入脚本/接口用于测试。
- **依赖 & 风险**
  - 需确认 MySQL 版本支持 `JSON` 字段；如不支持需采用 `MEDIUMTEXT`。
  - 评估字段长度，避免过大导致写入失败。
- **验收标准**
  - 迁移脚本上线，生产环境执行验证。
  - DAO 层单测覆盖写入、查询、重复写入等场景。
  - 文档内更新数据模型章节并记录上线时间。

## Phase 2：发布流程写快照

- **目标**：在 `DataTaskService.publish` 中生成并持久化快照，保证同步 DS 前已有留痕。
- **关键任务**
  - 实现 `WorkflowSnapshotBuilder`（或新增 Service）从现有发布逻辑构建标准化 JSON。
  - 调整发布事务：先写快照(`draft`)→ 同步 Dolphin → 更新快照状态 & 任务状态。
  - 处理失败补偿：同步失败时快照标记 `failed`，提供重试入口。
  - 记录发布人、触发来源等元数据。
  - 增加集成测试覆盖全流程。
  - 部署计划：灰度环境演练 → 生产低峰发布。
- **依赖 & 风险**
  - DolphinScheduler API 需保持兼容，确保复用 JSON 调用 `syncWorkflow` 成功。
  - 事务与异步调用（如清理临时工作流）需评估对快照状态的影响。
- **验收标准**
  - 发布任意任务后，可在表中看到一条 `published` 或 `failed` 快照记录。
  - 失败场景下从接口/日志可定位快照 ID 与错误信息。
  - `WorkflowLifecycleFullTest` 更新通过。

## Phase 3：版本查询 & Diff 能力

- **目标**：提供版本历史查询、差异比对的接口与基础 UI。
- **关键任务**
  - 开发 `WorkflowVersionService` 查询接口：列表（分页）、详情、拉取最近一次 published 版本。
  - 实现 `content_hash` 对比逻辑，根据需要输出结构化 diff（节点增删、依赖变动）。
  - 更新前端：新增版本列表页（筛选 workflow、状态、时间）、详情页展示 JSON 片段与 diff。
  - 编写后端单测、前端单元测试或 e2e 关键用例。
- **依赖 & 风险**
  - Diff 粒度需控制性能；建议先实现简要 diff（节点增删修改），后续再扩展。
  - 前端展示需控制 JSON 长度，可考虑折叠/下载模式。
- **验收标准**
  - API 文档更新；前端可查询任一 workflow 的历史版本。
  - diff 信息在 UI 可视化展示，并支持导出或复制。
  - 版本查询接口性能满足数据量预估（必要时压测）。

## Phase 4：回滚及治理能力

- **目标**：基于历史快照一键回滚至指定版本，并做好审计与权限控制。
- **关键任务**
  - 新增回滚 API：校验目标版本状态、触发新发布流程（复用 Phase 2 逻辑），记录 `rollback_of`。
  - 前端提供回滚入口（带提示 & 二次确认），与权限系统对接。
  - 审计记录：记录操作者、目标版本、时间及原因。
  - 编写回滚流程自动化测试（含成功、失败、权限不足）。
- **依赖 & 风险**
  - 回滚需与血缘数据保持一致，必要时在回滚前自动校验或强提示。
  - 需要明确多租户/多 workflow 并发回滚的锁策略。
- **验收标准**
  - 在测试环境执行一次回滚，验证 Dolphin workflow 与历史快照保持一致。
  - 审计记录可在后台或日志中查询。
  - 权限控制满足业务要求（仅特定角色可回滚）。

## Phase 5：运营化与交付关闭

- **目标**：完善监控、巡检、培训，确保方案可持续运维。
- **关键任务**
  - 监控：为快照写入失败、重复发布、回滚失败等事件设置告警（可通过日志或指标）。
  - 巡检脚本：定期检查快照与实际 workflow 差异，发现异常及时通知。
  - 操作手册：更新 docs/handbook，补充发布、回滚、故障处理步骤。
  - 内训或分享会，确保业务/运维了解新流程。
- **验收标准**
  - 监控告警在预生产验证通过。
  - 操作手册发布，并获得使用团队确认。
  - 项目关闭会议纪要，记录后续优化项。

## 资源与里程碑建议

- **核心人员**：后端 1-2、人前端 1、DBA 1、QA 1、运维 1（视阶段投入非全量）。
- **关键里程碑**
  - M1：Phase 1 完成，数据库结构上线。
  - M2：Phase 2 完成，快照全量写入并在生产稳定运行。
  - M3：Phase 3 完成，版本查询上线。
  - M4：Phase 4 完成，回滚可通过审批流程执行。
  - M5：Phase 5 完成，项目交付关闭。

## 后续跟踪

- 每阶段结束召开评审或复盘会议，更新风险列表与下一阶段计划。
- 将关键指标（快照生成成功率、回滚执行次数等）纳入季度运维报表。
- 根据业务反馈追加功能需求，例如自动化审批、差异通知等。

